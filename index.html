<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PharmaBoard+ - Tableau de bord pharmacien itin√©rant</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --primary-color: #0984e3;
            --secondary-color: #74b9ff;
            --accent-color: #ff6b35;
            --accent-hover: #ff8c5a;
            --bg-dark: #0a0a0a;
            --bg-dark-secondary: #1a1a1a;
            --bg-dark-tertiary: #2a2a2a;
            --text-light: #f5f5f5;
            --text-muted: #a0a0a0;
            --border-color: #333;
            --success-color: #00b894;
            --danger-color: #d63031;
            --warning-color: #fdcb6e;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-light);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .sidebar {
            background-color: var(--bg-dark-secondary);
            min-height: 100vh;
            transition: all 0.3s;
            border-right: 1px solid var(--border-color);
            position: fixed;
            top: 0;
            left: 0;
            width: 280px;
            z-index: 1000;
        }

        .main-content {
            margin-left: 280px;
            padding: 2rem;
            background-color: var(--bg-dark);
            min-height: 100vh;
        }

        .sidebar .nav-link {
            color: var(--text-muted);
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            transition: all 0.3s;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            display: flex;
            align-items: center;
        }

        .sidebar .nav-link:hover {
            background-color: rgba(255, 107, 53, 0.1);
            color: var(--accent-color);
            transform: translateX(5px);
        }

        .sidebar .nav-link.active {
            background-color: rgba(9, 132, 227, 0.2);
            color: var(--primary-color);
            border-left: 3px solid var(--primary-color);
        }

        .pharmacy-selector {
            background-color: rgba(255, 107, 53, 0.1);
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 2rem;
            border: 1px solid rgba(255, 107, 53, 0.3);
        }

        .stat-card {
            background: var(--bg-dark-secondary);
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            transition: all 0.3s;
            border: 1px solid var(--border-color);
            color: var(--text-light);
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.5);
            border-color: var(--primary-color);
        }

        .contact-card {
            background: var(--bg-dark-secondary);
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
            transition: all 0.2s;
            border: 1px solid var(--border-color);
        }

        .contact-card.favori {
            border-left: 4px solid var(--accent-color);
        }

        .contact-card.confidentiel {
            background-color: rgba(255, 107, 53, 0.1);
            border-color: var(--accent-color);
        }

        .quick-action-btn {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 1rem;
            border-radius: 0.5rem;
            transition: all 0.3s;
            width: 100%;
            margin-bottom: 1rem;
        }

        .quick-action-btn:hover {
            background-color: var(--accent-hover);
            transform: scale(1.02);
            box-shadow: 0 4px 8px rgba(255, 107, 53, 0.3);
        }

        .form-control, .form-select {
            background-color: var(--bg-dark-secondary);
            border-color: var(--border-color);
            color: var(--text-light);
        }

        .form-control:focus, .form-select:focus {
            background-color: var(--bg-dark-secondary);
            border-color: var(--primary-color);
            color: var(--text-light);
            box-shadow: 0 0 0 0.25rem rgba(9, 132, 227, 0.25);
        }

        .modal-content {
            background-color: var(--bg-dark-secondary);
            color: var(--text-light);
            border: 1px solid var(--border-color);
        }

        .modal-header {
            border-bottom: 1px solid var(--border-color);
        }

        .modal-footer {
            border-top: 1px solid var(--border-color);
        }

        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .btn-secondary {
            background-color: var(--bg-dark-tertiary);
            border-color: var(--border-color);
            color: var(--text-light);
        }

        .btn-success {
            background-color: var(--success-color);
            border-color: var(--success-color);
        }

        .btn-danger {
            background-color: var(--danger-color);
            border-color: var(--danger-color);
        }

        .btn-warning {
            background-color: var(--warning-color);
            border-color: var(--warning-color);
            color: #000;
        }

        .card {
            background-color: var(--bg-dark-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-light);
        }

        .card-header {
            background-color: var(--bg-dark-tertiary);
            border-bottom: 1px solid var(--border-color);
        }

        .table-dark {
            --bs-table-bg: var(--bg-dark-secondary);
            --bs-table-border-color: var(--border-color);
        }

        .badge {
            font-size: 0.75em;
        }

        .text-muted {
            color: var(--text-muted) !important;
        }

        .border {
            border-color: var(--border-color) !important;
        }

        .search-box {
            position: relative;
        }

        .search-box .bi-search {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
        }

        .search-box input {
            padding-left: 2.5rem;
        }

        .medicine-search-box {
            background-color: var(--bg-dark-secondary);
            padding: 1.5rem;
            border-radius: 0.75rem;
            border: 1px solid var(--border-color);
        }

        .medicine-search-box:focus-within {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.25rem rgba(9, 132, 227, 0.1);
        }

        .category-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            background-color: rgba(9, 132, 227, 0.2);
            border: 1px solid var(--primary-color);
            color: var(--secondary-color);
            border-radius: 0.25rem;
            font-size: 0.75rem;
            margin-right: 0.25rem;
            margin-bottom: 0.25rem;
        }

        .note-tag {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            background-color: rgba(116, 185, 255, 0.2);
            border: 1px solid var(--secondary-color);
            color: var(--secondary-color);
            border-radius: 1rem;
            font-size: 0.75rem;
        }

        .alert-success {
            background-color: rgba(0, 184, 148, 0.1);
            border-color: var(--success-color);
            color: var(--success-color);
        }

        .alert-danger {
            background-color: rgba(214, 48, 49, 0.1);
            border-color: var(--danger-color);
            color: var(--danger-color);
        }

        .alert-warning {
            background-color: rgba(253, 203, 110, 0.1);
            border-color: var(--warning-color);
            color: var(--warning-color);
        }

        .alert-info {
            background-color: rgba(116, 185, 255, 0.1);
            border-color: var(--secondary-color);
            color: var(--secondary-color);
        }

        /* STYLES SP√âCIFIQUES POUR LES T√ÇCHES CLIQUABLES */
        .task-item {
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid transparent;
            user-select: none;
        }

        .task-item:hover {
            background-color: rgba(9, 132, 227, 0.1) !important;
            border-color: var(--primary-color) !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(9, 132, 227, 0.2);
        }

        .task-item:hover .task-title {
            color: var(--primary-color) !important;
            font-weight: 600;
        }

        .task-item:hover .task-category {
            background-color: var(--primary-color) !important;
            color: white !important;
        }

        .task-item:active {
            transform: translateY(0);
            box-shadow: 0 2px 6px rgba(9, 132, 227, 0.3);
        }

        /* OPTIMISATION POUR PLUS DE T√ÇCHES VISIBLES */
        .tasks-container {
            max-height: 400px;
            overflow-y: auto;
        }

        .tasks-container::-webkit-scrollbar {
            width: 6px;
        }

        .tasks-container::-webkit-scrollbar-track {
            background: var(--bg-dark-tertiary);
            border-radius: 3px;
        }

        .tasks-container::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 3px;
        }

        .tasks-container::-webkit-scrollbar-thumb:hover {
            background: var(--secondary-color);
        }

        /* ALERTE DE CONFLIT */
        .conflict-alert {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 400px;
            background: linear-gradient(135deg, #ff6b35, #ff8c5a);
            color: white;
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 12px rgba(255, 107, 53, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: -280px;
                width: 280px;
                z-index: 1000;
            }
            
            .sidebar.show {
                left: 0;
            }
            
            .main-content {
                margin-left: 0;
            }

            .mobile-menu-btn {
                display: block;
                position: fixed;
                top: 1rem;
                left: 1rem;
                z-index: 1001;
                background-color: var(--primary-color);
                color: white;
                border: none;
                padding: 0.5rem;
                border-radius: 0.25rem;
            }
        }

        @media (min-width: 769px) {
            .mobile-menu-btn {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- Alerte de conflit -->
    <div id="conflictAlert" class="conflict-alert" style="display: none;">
        <div class="d-flex align-items-center mb-2">
            <i class="bi bi-exclamation-triangle me-2"></i>
            <strong>‚ö†Ô∏è Conflit d√©tect√©</strong>
        </div>
        <p class="mb-2 small">Plusieurs versions de PharmaBoard+ sont ouvertes. Fermez les autres onglets pour √©viter la perte de donn√©es.</p>
        <button class="btn btn-sm btn-light" onclick="hideConflictAlert()">Compris</button>
    </div>

    <!-- Mobile menu button -->
    <button class="mobile-menu-btn d-md-none" onclick="toggleSidebar()">
        <i class="bi bi-list"></i>
    </button>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="p-3">
            <div class="d-flex align-items-center mb-4">
                <div class="bg-primary rounded p-2 me-3">
                    <i class="bi bi-capsule text-white fs-4"></i>
                </div>
                <div>
                    <h4 class="mb-0">PharmaBoard+</h4>
                    <small class="text-muted">v2.0 Delete Fixed</small>
                </div>
            </div>

            <!-- Pharmacy Selector -->
            <div class="pharmacy-selector">
                <label class="form-label small text-muted">Pharmacie active</label>
                <select class="form-select form-select-sm mb-2" id="pharmacySelect" onchange="changePharmacy()">
                    <option value="">S√©lectionner une pharmacie</option>
                </select>
                <div class="d-flex gap-2">
                    <button class="btn btn-primary btn-sm flex-fill" onclick="addPharmacy()">
                        <i class="bi bi-plus"></i> Nouvelle
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="deletePharmacy()" id="deletePharmacyBtn" style="display: none;">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </div>

            <!-- Navigation -->
            <nav>
                <button class="nav-link active" onclick="showPage('dashboard')">
                    <i class="bi bi-speedometer2 me-2"></i>
                    Tableau de bord
                </button>
                <button class="nav-link" onclick="showPage('contacts')">
                    <i class="bi bi-people me-2"></i>
                    Contacts
                </button>
                <button class="nav-link" onclick="showPage('notes')">
                    <i class="bi bi-journal-text me-2"></i>
                    Notes
                </button>
                <button class="nav-link" onclick="showPage('messages')">
                    <i class="bi bi-chat-dots me-2"></i>
                    Messages
                </button>
                <button class="nav-link" onclick="showPage('checklist')">
                    <i class="bi bi-check-square me-2"></i>
                    Checklist
                </button>
                <button class="nav-link" onclick="showPage('settings')">
                    <i class="bi bi-gear me-2"></i>
                    Param√®tres
                </button>
            </nav>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Dashboard Page -->
        <div id="dashboardPage" class="page-content">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h2 mb-1">Tableau de bord</h1>
                    <p class="text-muted">Vue d'ensemble de votre activit√©</p>
                </div>
                <div class="text-end">
                    <small class="text-muted" id="currentDate"></small>
                </div>
            </div>

            <!-- Statistics Cards -->
            <div class="row g-3 mb-4">
                <div class="col-md-6 col-lg">
                    <div class="stat-card text-center">
                        <i class="bi bi-star-fill text-warning fs-2 mb-2"></i>
                        <h3 class="mb-0" id="statContactsFavoris">0</h3>
                        <small class="text-muted">Contacts Favoris</small>
                    </div>
                </div>
                <div class="col-md-6 col-lg">
                    <div class="stat-card text-center">
                        <i class="bi bi-journal-text text-primary fs-2 mb-2"></i>
                        <h3 class="mb-0" id="statNotes">0</h3>
                        <small class="text-muted">Notes</small>
                    </div>
                </div>
                <div class="col-md-6 col-lg">
                    <div class="stat-card text-center">
                        <i class="bi bi-chat-dots text-success fs-2 mb-2"></i>
                        <h3 class="mb-0" id="statMessages">0</h3>
                        <small class="text-muted">Messages</small>
                    </div>
                </div>
                <div class="col-md-6 col-lg">
                    <div class="stat-card text-center">
                        <i class="bi bi-capsule text-info fs-2 mb-2"></i>
                        <h3 class="mb-0" id="statPharmacies">0</h3>
                        <small class="text-muted">Pharmacies</small>
                    </div>
                </div>
                <div class="col-md-6 col-lg">
                    <div class="stat-card text-center">
                        <i class="bi bi-check-square text-secondary fs-2 mb-2"></i>
                        <h3 class="mb-0" id="statTaches">0/0</h3>
                        <small class="text-muted">T√¢ches</small>
                        <div class="small text-muted mt-1" id="statTachesPercent">0% compl√©t√©es</div>
                    </div>
                </div>
            </div>

            <div class="row g-4">
                <!-- Actions rapides -->
                <div class="col-lg-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="bi bi-lightning-charge text-warning me-2"></i>
                                Actions rapides
                            </h5>
                        </div>
                        <div class="card-body">
                            <button class="quick-action-btn" onclick="quickNote()">
                                <i class="bi bi-plus-circle me-2"></i>
                                Note rapide
                            </button>
                            <button class="quick-action-btn" onclick="quickContact()">
                                <i class="bi bi-person-plus me-2"></i>
                                Nouveau contact
                            </button>
                            <button class="quick-action-btn" onclick="quickMessage()">
                                <i class="bi bi-chat-plus me-2"></i>
                                Nouveau message
                            </button>
                            <button class="quick-action-btn" onclick="quickChecklist()">
                                <i class="bi bi-check-square me-2"></i>
                                Nouvelle checklist
                            </button>
                        </div>
                    </div>
                </div>

                <!-- T√¢ches en cours - OPTIMIS√âES POUR PLUS D'AFFICHAGE -->
                <div class="col-lg-6">
                    <div class="card h-100">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="bi bi-clock text-warning me-2"></i>
                                T√¢ches en cours
                                <span class="badge bg-primary ms-2" id="taskCount">0</span>
                            </h5>
                        </div>
                        <div class="card-body p-0">
                            <div class="tasks-container p-3" id="recentTasks">
                                <p class="text-muted text-center py-4">Aucune t√¢che en cours</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Contacts prioritaires -->
                <div class="col-lg-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="bi bi-star text-warning me-2"></i>
                                Contacts prioritaires (6 max)
                            </h5>
                        </div>
                        <div class="card-body">
                            <div id="favoriteContacts">
                                <p class="text-muted text-center py-4">Aucun contact prioritaire</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recherche de m√©dicaments - D√âPLAC√âE PLUS BAS -->
                <div class="col-lg-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="bi bi-search text-success me-2"></i>
                                Recherche de m√©dicaments
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="search-box mb-3">
                                <i class="bi bi-search"></i>
                                <input type="text" class="form-control" placeholder="Rechercher un m√©dicament..." id="medicineSearch" oninput="searchMedicines()">
                            </div>
                            <div id="medicineResults" style="max-height: 300px; overflow-y: auto;">
                                <!-- R√©sultats de recherche -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recherche de contacts par m√©dicament -->
            <div class="row g-4 mt-2">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="bi bi-people text-primary me-2"></i>
                                Recherche de contacts par m√©dicament
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="search-box mb-3">
                                <i class="bi bi-search"></i>
                                <input type="text" class="form-control" placeholder="Rechercher un contact par m√©dicament..." id="contactMedicineSearch" oninput="searchContactsByMedicine()">
                            </div>
                            <div id="contactMedicineResults" class="row g-3">
                                <!-- R√©sultats de recherche -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contacts Page -->
        <div id="contactsPage" class="page-content" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h2 mb-1">Contacts</h1>
                    <p class="text-muted">G√©rez vos contacts professionnels</p>
                </div>
                <button class="btn btn-primary" onclick="openContactModal()">
                    <i class="bi bi-plus"></i> Nouveau contact
                </button>
            </div>

            <!-- Filters -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <div class="search-box">
                                <i class="bi bi-search"></i>
                                <input type="text" class="form-control" placeholder="Rechercher un contact..." id="contactSearch" oninput="filterContacts()">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="contactTypeFilter" onchange="filterContacts()">
                                <option value="">Tous les contacts</option>
                                <option value="favoris">Favoris uniquement</option>
                                <option value="confidentiels">Confidentiels</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="contactPharmacyFilter" onchange="filterContacts()">
                                <option value="">Toutes les pharmacies</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <div class="d-flex align-items-center text-muted">
                                <i class="bi bi-funnel me-2"></i>
                                <span id="contactCount">0 contact(s)</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contacts List -->
            <div id="contactsList">
                <!-- Contacts will be displayed here -->
            </div>
        </div>

        <!-- Notes Page -->
        <div id="notesPage" class="page-content" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h2 mb-1">Notes</h1>
                    <p class="text-muted">G√©rez vos notes et documentations</p>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-success" onclick="exportNotesPDF()">
                        <i class="bi bi-download"></i> Export PDF
                    </button>
                    <button class="btn btn-primary" onclick="openNoteModal()">
                        <i class="bi bi-plus"></i> Nouvelle note
                    </button>
                </div>
            </div>

            <!-- Filters -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <div class="search-box">
                                <i class="bi bi-search"></i>
                                <input type="text" class="form-control" placeholder="Rechercher dans les notes..." id="noteSearch" oninput="filterNotes()">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="noteTagFilter" onchange="filterNotes()">
                                <option value="">Tous les tags</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="noteContactFilter" onchange="filterNotes()">
                                <option value="">Tous les contacts</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <div class="d-flex align-items-center text-muted">
                                <i class="bi bi-funnel me-2"></i>
                                <span id="noteCount">0 note(s)</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Notes List -->
            <div id="notesList" class="row g-4">
                <!-- Notes will be displayed here -->
            </div>
        </div>

        <!-- Messages Page -->
        <div id="messagesPage" class="page-content" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h2 mb-1">Messages</h1>
                    <p class="text-muted">G√©rez vos communications</p>
                </div>
                <button class="btn btn-primary" onclick="openMessageModal()">
                    <i class="bi bi-plus"></i> Nouveau message
                </button>
            </div>

            <!-- Filters -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <div class="search-box">
                                <i class="bi bi-search"></i>
                                <input type="text" class="form-control" placeholder="Rechercher un message..." id="messageSearch" oninput="filterMessages()">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="messageTypeFilter" onchange="filterMessages()">
                                <option value="">Tous les types</option>
                                <option value="email">Email</option>
                                <option value="sms">SMS</option>
                                <option value="note">Note interne</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="messageContactFilter" onchange="filterMessages()">
                                <option value="">Tous les contacts</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <div class="d-flex align-items-center text-muted">
                                <i class="bi bi-funnel me-2"></i>
                                <span id="messageCount">0 message(s)</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Messages List -->
            <div id="messagesList">
                <!-- Messages will be displayed here -->
            </div>
        </div>

        <!-- Checklist Page -->
        <div id="checklistPage" class="page-content" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h2 mb-1">Checklist</h1>
                    <p class="text-muted">G√©rez vos t√¢ches et proc√©dures</p>
                </div>
                <button class="btn btn-primary" onclick="openChecklistModal()">
                    <i class="bi bi-plus"></i> Nouvelle checklist
                </button>
            </div>

            <!-- Filters -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-2">
                            <div class="search-box">
                                <i class="bi bi-search"></i>
                                <input type="text" class="form-control" placeholder="Rechercher..." id="checklistSearch" oninput="filterChecklist()">
                            </div>
                        </div>
                        <div class="col-md-2">
                            <select class="form-select" id="checklistCategoryFilter" onchange="filterChecklist()">
                                <option value="">Toutes les cat√©gories</option>
                                <option value="logistique">üì¶ Logistique</option>
                                <option value="patient">üë§ Patient</option>
                                <option value="ordinateur">üíª Ordinateur</option>
                                <option value="todo">‚úÖ Todo</option>
                                <option value="medecin">üë®‚Äç‚öïÔ∏è M√©decin</option>
                                <option value="procedure">üìã Proc√©dure</option>
                                <option value="grossiste">üè¢ Grossiste</option>
                                <option value="magistrale">‚öóÔ∏è Magistrale</option>
                                <option value="tarification">üí∞ Tarification</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <select class="form-select" id="checklistStatusFilter" onchange="filterChecklist()">
                                <option value="">Tous les statuts</option>
                                <option value="pending">En cours</option>
                                <option value="completed">Compl√©t√©s</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <select class="form-select" id="checklistPharmacyFilter" onchange="filterChecklist()">
                                <option value="">Toutes les pharmacies</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <div class="d-flex align-items-center text-muted">
                                <i class="bi bi-funnel me-2"></i>
                                <span id="checklistCount">0 item(s)</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Checklist Items -->
            <div id="checklistItems">
                <!-- Checklist items will be displayed here -->
            </div>
        </div>

        <!-- Settings Page -->
        <div id="settingsPage" class="page-content" style="display: none;">
            <div class="mb-4">
                <h1 class="h2 mb-1">Param√®tres</h1>
                <p class="text-muted">G√©rez les pr√©f√©rences et donn√©es de l'application</p>
            </div>

            <div class="row g-4">
                <!-- Gestion des donn√©es -->
                <div class="col-lg-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="bi bi-database text-primary me-2"></i>
                                Gestion des donn√©es
                            </h5>
                        </div>
                        <div class="card-body">
                            <p class="text-muted mb-4">Sauvegardez ou restaurez vos donn√©es PharmaBoard+</p>
                            <div class="d-grid gap-3">
                                <button class="btn btn-success" onclick="exportData()">
                                    <i class="bi bi-download me-2"></i>
                                    Exporter les donn√©es
                                </button>
                                <button class="btn btn-primary" onclick="importData()">
                                    <i class="bi bi-upload me-2"></i>
                                    Importer les donn√©es
                                </button>
                                <button class="btn btn-danger" onclick="clearAllData()">
                                    <i class="bi bi-trash me-2"></i>
                                    Effacer toutes les donn√©es
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Pr√©f√©rences -->
                <div class="col-lg-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="bi bi-sliders text-secondary me-2"></i>
                                Pr√©f√©rences
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center p-3 bg-dark rounded mb-3">
                                <div>
                                    <h6 class="mb-1">Sauvegarde automatique</h6>
                                    <small class="text-muted">Sauvegarde automatique toutes les 30 secondes</small>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="autoSaveToggle" checked onchange="toggleAutoSave()">
                                </div>
                            </div>
                            <div class="d-flex justify-content-between align-items-center p-3 bg-dark rounded">
                                <div>
                                    <h6 class="mb-1">Notifications</h6>
                                    <small class="text-muted">Afficher les notifications syst√®me</small>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="notificationsToggle" checked onchange="toggleNotifications()">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Informations -->
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="bi bi-info-circle text-info me-2"></i>
                                Informations de l'application
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-4 mb-4">
                                <div class="col-md-3">
                                    <div class="text-center p-3 bg-dark rounded">
                                        <div class="h3 text-primary mb-0" id="infoPharmacies">0</div>
                                        <small class="text-muted">Pharmacies</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center p-3 bg-dark rounded">
                                        <div class="h3 text-success mb-0" id="infoContacts">0</div>
                                        <small class="text-muted">Contacts</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center p-3 bg-dark rounded">
                                        <div class="h3 text-warning mb-0" id="infoNotes">0</div>
                                        <small class="text-muted">Notes</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center p-3 bg-dark rounded">
                                        <div class="h3 text-info mb-0" id="infoMessages">0</div>
                                        <small class="text-muted">Messages</small>
                                    </div>
                                </div>
                            </div>
                            <div class="border-top pt-3">
                                <div class="row">
                                    <div class="col-md-6">
                                        <small class="text-muted"><strong>Version :</strong> PharmaBoard+ v2.0 Delete Fixed</small>
                                    </div>
                                    <div class="col-md-6 text-md-end">
                                        <small class="text-muted"><strong>Derni√®re sauvegarde :</strong> <span id="lastSave"></span></small>
                                    </div>
                                </div>
                                <div class="mt-2">
                                    <small class="text-muted"><strong>Checklist :</strong> <span id="infoChecklist">0 items (0 compl√©t√©s)</span></small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Contact Modal -->
    <div class="modal fade" id="contactModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Nouveau contact</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="contactForm">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Nom *</label>
                                <input type="text" class="form-control" id="contactNom" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Pr√©nom</label>
                                <input type="text" class="form-control" id="contactPrenom">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">R√¥le/Fonction</label>
                                <input type="text" class="form-control" id="contactRole" placeholder="Ex: Pharmacien titulaire">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-control" id="contactEmail">
                            </div>
                            <div class="col-12">
                                <h6 class="border-bottom pb-2">Num√©ros de t√©l√©phone</h6>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">T√©l√©phone fixe</label>
                                <input type="tel" class="form-control" id="contactFixe">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">GSM</label>
                                <input type="tel" class="form-control" id="contactGsm">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Bureau</label>
                                <input type="tel" class="form-control" id="contactBureau">
                            </div>
                            <div class="col-12">
                                <label class="form-label">T√©l√©phone favori (affich√© sur le tableau de bord)</label>
                                <select class="form-select" id="contactTelFavori">
                                    <option value="">Aucun t√©l√©phone favori</option>
                                </select>
                            </div>
                            <div class="col-12">
                                <label class="form-label">M√©dicament associ√©</label>
                                <input type="text" class="form-control" id="contactMedicament" placeholder="Ex: Doliprane, Advil...">
                                <div class="form-text">Permet de retrouver ce contact via la recherche de m√©dicaments</div>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Adresse</label>
                                <textarea class="form-control" id="contactAdresse" rows="2"></textarea>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Notes</label>
                                <textarea class="form-control" id="contactNotes" rows="3" placeholder="Informations suppl√©mentaires..."></textarea>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="contactFavori">
                                    <label class="form-check-label">
                                        <i class="bi bi-star text-warning me-1"></i>
                                        Marquer comme favori
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="contactConfidentiel">
                                    <label class="form-check-label">
                                        <i class="bi bi-lock text-danger me-1"></i>
                                        Contact confidentiel
                                    </label>
                                </div>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Pharmacie associ√©e</label>
                                <select class="form-select" id="contactPharmacie">
                                    <option value="">Toutes les pharmacies (contact global)</option>
                                </select>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary" onclick="saveContact()">Ajouter</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Note Modal -->
    <div class="modal fade" id="noteModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Nouvelle note</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="noteForm">
                        <div class="mb-3">
                            <label class="form-label">Titre (optionnel)</label>
                            <input type="text" class="form-control" id="noteTitre" placeholder="Titre de la note...">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Contenu *</label>
                            <textarea class="form-control" id="noteContenu" rows="8" placeholder="Contenu de la note..." required></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Images (max 5, 1MB chacune)</label>
                            <input type="file" class="form-control" id="noteImages" multiple accept="image/*" onchange="handleNoteImages()">
                            <div id="noteImagePreviews" class="mt-2"></div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Tags</label>
                            <input type="text" class="form-control" id="noteTags" placeholder="S√©parez les tags par des virgules (ex: urgent, commande, fournisseur)">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Associer √† un contact</label>
                            <select class="form-select" id="noteContact">
                                <option value="">Aucun contact</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Pharmacie</label>
                            <select class="form-select" id="notePharmacie">
                                <option value="">Toutes les pharmacies</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary" onclick="saveNote()">Ajouter</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Message Modal -->
    <div class="modal fade" id="messageModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Nouveau message</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="messageForm">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Type de message *</label>
                                <select class="form-select" id="messageType" required>
                                    <option value="email">üìß Email</option>
                                    <option value="sms">üì± SMS</option>
                                    <option value="note">üìù Note interne</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check mt-4">
                                    <input class="form-check-input" type="checkbox" id="messageUrgent">
                                    <label class="form-check-label">
                                        <i class="bi bi-exclamation-triangle text-danger me-1"></i>
                                        Message urgent
                                    </label>
                                </div>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Destinataires *</label>
                                <div class="mb-3">
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="destinataireType" id="destTous" value="tous">
                                        <label class="form-check-label">Tous les contacts</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="destinataireType" id="destFavoris" value="favoris">
                                        <label class="form-check-label">Contacts favoris</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="destinataireType" id="destSelection" value="selection" checked>
                                        <label class="form-check-label">S√©lection manuelle</label>
                                    </div>
                                </div>
                                <div id="contactSelection" class="border rounded p-3" style="max-height: 200px; overflow-y: auto;">
                                    <!-- Contact selection will be populated here -->
                                </div>
                                <div class="mt-2">
                                    <small class="text-muted">üìä <span id="destinataireCount">0</span> destinataire(s) s√©lectionn√©(s)</small>
                                </div>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Sujet *</label>
                                <input type="text" class="form-control" id="messageSujet" placeholder="Sujet du message..." required>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Contenu *</label>
                                <textarea class="form-control" id="messageContenu" rows="8" placeholder="Contenu du message..." required></textarea>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Pharmacie</label>
                                <select class="form-select" id="messagePharmacie">
                                    <option value="">Toutes les pharmacies</option>
                                </select>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary" onclick="saveMessage()">Envoyer</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Checklist Modal -->
    <div class="modal fade" id="checklistModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Nouvelle checklist</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="checklistForm">
                        <div class="row g-3">
                            <div class="col-md-8">
                                <label class="form-label">Titre *</label>
                                <input type="text" class="form-control" id="checklistTitre" placeholder="Titre de la checklist..." required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Cat√©gorie *</label>
                                <select class="form-select" id="checklistCategorie" required>
                                    <option value="">S√©lectionner...</option>
                                    <option value="logistique">üì¶ Logistique</option>
                                    <option value="patient">üë§ Patient</option>
                                    <option value="ordinateur">üíª Ordinateur</option>
                                    <option value="todo">‚úÖ Todo</option>
                                    <option value="medecin">üë®‚Äç‚öïÔ∏è M√©decin</option>
                                    <option value="procedure">üìã Proc√©dure</option>
                                    <option value="grossiste">üè¢ Grossiste</option>
                                    <option value="magistrale">‚öóÔ∏è Magistrale</option>
                                    <option value="tarification">üí∞ Tarification</option>
                                </select>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Contenu *</label>
                                <textarea class="form-control" id="checklistContenu" rows="6" placeholder="Description d√©taill√©e..." required></textarea>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Images (max 5, 1MB chacune)</label>
                                <input type="file" class="form-control" id="checklistImages" multiple accept="image/*" onchange="handleChecklistImages()">
                                <div id="checklistImagePreviews" class="mt-2"></div>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Tableau (optionnel)</label>
                                <div class="border rounded p-3 bg-dark">
                                    <div class="d-flex gap-2 mb-3">
                                        <button type="button" class="btn btn-primary btn-sm" onclick="addTableColumn()">
                                            <i class="bi bi-plus"></i> Ajouter colonne
                                        </button>
                                        <button type="button" class="btn btn-success btn-sm" onclick="addTableRow()">
                                            <i class="bi bi-plus"></i> Ajouter ligne
                                        </button>
                                        <button type="button" class="btn btn-danger btn-sm" onclick="clearTable()">
                                            <i class="bi bi-trash"></i> Effacer tableau
                                        </button>
                                    </div>
                                    <div id="tableContainer">
                                        <p class="text-muted text-center py-3">Aucun tableau. Cliquez sur "Ajouter colonne" pour commencer.</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="checklistFavori">
                                    <label class="form-check-label">
                                        <i class="bi bi-star text-warning me-1"></i>
                                        Marquer comme favori
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="checklistComplete">
                                    <label class="form-check-label">
                                        ‚úÖ Marquer comme compl√©t√©
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Pharmacie</label>
                                <select class="form-select" id="checklistPharmacie">
                                    <option value="">Toutes les pharmacies</option>
                                </select>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary" onclick="saveChecklist()">Ajouter</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Toast -->
    <div class="toast-container position-fixed top-0 end-0 p-3">
        <div id="notificationToast" class="toast" role="alert">
            <div class="toast-header">
                <i class="bi bi-info-circle text-primary me-2"></i>
                <strong class="me-auto">PharmaBoard+</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="toastMessage">
                <!-- Message will be inserted here -->
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let currentPage = 'dashboard';
        let currentPharmacy = '';
        let editingContactId = null;
        let editingNoteId = null;
        let editingMessageId = null;
        let editingChecklistId = null;
        let noteImages = [];
        let checklistImages = [];
        let tableData = { colonnes: [], lignes: [] };
        let lastDataHash = '';
        let isUpdating = false;

        // Medicine database
        const medicineDatabase = [
            { name: 'Doliprane 1000mg', type: 'Comprim√©s', manufacturer: 'Sanofi', price: 3.50, available: true },
            { name: 'Advil 400mg', type: 'Comprim√©s', manufacturer: 'Pfizer', price: 4.20, available: true },
            { name: 'Aspirin 500mg', type: 'Comprim√©s', manufacturer: 'Bayer', price: 2.80, available: false },
            { name: 'Paracetamol 500mg', type: 'G√©lules', manufacturer: 'Biogaran', price: 2.10, available: true },
            { name: 'Ibuprofen 200mg', type: 'Comprim√©s', manufacturer: 'Mylan', price: 3.90, available: true },
            { name: 'Spasfon', type: 'Comprim√©s', manufacturer: 'Teva', price: 5.80, available: false },
            { name: 'Smecta', type: 'Poudre', manufacturer: 'Ipsen', price: 6.10, available: true }
        ];

        // SYST√àME DE D√âTECTION DE CONFLIT
        function generateDataHash() {
            const data = {
                pharmacies: getData('pharmacies'),
                contacts: getData('contacts'),
                notes: getData('notes'),
                messages: getData('messages'),
                checklist_items: getData('checklist_items')
            };
            return JSON.stringify(data).length.toString();
        }

        function checkForConflicts() {
            if (isUpdating) return;
            
            const currentHash = generateDataHash();
            if (lastDataHash && lastDataHash !== currentHash) {
                showConflictAlert();
            }
            lastDataHash = currentHash;
        }

        function showConflictAlert() {
            document.getElementById('conflictAlert').style.display = 'block';
        }

        function hideConflictAlert() {
            document.getElementById('conflictAlert').style.display = 'none';
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            updateCurrentDate();
            updateDashboard();
            updatePharmacySelectors();
            lastDataHash = generateDataHash();
            
            // Auto-save every 30 seconds
            setInterval(saveData, 30000);
            
            // Check for conflicts every 5 seconds
            setInterval(checkForConflicts, 5000);
        });

        // FONCTION DE SAUVEGARDE S√âCURIS√âE
        function saveDataSafely(type, data) {
            isUpdating = true;
            try {
                localStorage.setItem(`pharmaboard_${type}`, JSON.stringify(data));
                lastDataHash = generateDataHash();
            } catch (error) {
                console.error('Erreur lors de la sauvegarde:', error);
                showNotification('Erreur lors de la sauvegarde', 'error');
            } finally {
                isUpdating = false;
            }
        }

        // Data management
        function loadData() {
            // Load from localStorage or initialize empty arrays
            if (!localStorage.getItem('pharmaboard_pharmacies')) {
                localStorage.setItem('pharmaboard_pharmacies', JSON.stringify([]));
            }
            if (!localStorage.getItem('pharmaboard_contacts')) {
                localStorage.setItem('pharmaboard_contacts', JSON.stringify([]));
            }
            if (!localStorage.getItem('pharmaboard_notes')) {
                localStorage.setItem('pharmaboard_notes', JSON.stringify([]));
            }
            if (!localStorage.getItem('pharmaboard_messages')) {
                localStorage.setItem('pharmaboard_messages', JSON.stringify([]));
            }
            if (!localStorage.getItem('pharmaboard_checklist_items')) {
                localStorage.setItem('pharmaboard_checklist_items', JSON.stringify([]));
            }
            
            currentPharmacy = localStorage.getItem('pharmaboard_current_pharmacy') || '';
        }

        function saveData() {
            // Data is saved automatically when modified
            if (!isUpdating) {
                showNotification('Donn√©es sauvegard√©es automatiquement');
            }
        }

        function getData(type) {
            return JSON.parse(localStorage.getItem(`pharmaboard_${type}`) || '[]');
        }

        function setData(type, data) {
            saveDataSafely(type, data);
        }

        // Navigation
        function showPage(page) {
            // Hide all pages
            document.querySelectorAll('.page-content').forEach(p => p.style.display = 'none');
            
            // Show selected page
            document.getElementById(page + 'Page').style.display = 'block';
            
            // Update navigation
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
            event.target.classList.add('active');
            
            currentPage = page;
            
            // Load page-specific data
            switch(page) {
                case 'contacts':
                    loadContacts();
                    break;
                case 'notes':
                    loadNotes();
                    break;
                case 'messages':
                    loadMessages();
                    break;
                case 'checklist':
                    loadChecklist();
                    break;
                case 'settings':
                    loadSettings();
                    break;
                case 'dashboard':
                    updateDashboard();
                    break;
            }
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('show');
        }

        // Pharmacy management
        function addPharmacy() {
            const nom = prompt('Nom de la pharmacie:');
            if (nom?.trim()) {
                const adresse = prompt('Adresse de la pharmacie:') || '';
                const pharmacies = getData('pharmacies');
                const newPharmacy = {
                    id: Date.now().toString(),
                    nom: nom.trim(),
                    adresse,
                    dateCreation: new Date().toISOString(),
                };
                pharmacies.push(newPharmacy);
                setData('pharmacies', pharmacies);
                updatePharmacySelectors();
                showNotification('Pharmacie ajout√©e avec succ√®s');
            }
        }

        function deletePharmacy() {
            if (!currentPharmacy) return;
            
            const pharmacies = getData('pharmacies');
            const pharmacy = pharmacies.find(p => p.id === currentPharmacy);
            if (pharmacy && confirm(`√ätes-vous s√ªr de vouloir supprimer la pharmacie "${pharmacy.nom}" ?`)) {
                const updatedPharmacies = pharmacies.filter(p => p.id !== currentPharmacy);
                setData('pharmacies', updatedPharmacies);
                localStorage.removeItem('pharmaboard_current_pharmacy');
                currentPharmacy = '';
                updatePharmacySelectors();
                showNotification('Pharmacie supprim√©e');
            }
        }

        function changePharmacy() {
            currentPharmacy = document.getElementById('pharmacySelect').value;
            if (currentPharmacy) {
                localStorage.setItem('pharmaboard_current_pharmacy', currentPharmacy);
            } else {
                localStorage.removeItem('pharmaboard_current_pharmacy');
            }
            updateDashboard();
            if (currentPage === 'contacts') loadContacts();
            if (currentPage === 'notes') loadNotes();
            if (currentPage === 'messages') loadMessages();
            if (currentPage === 'checklist') loadChecklist();
        }

        function updatePharmacySelectors() {
            const pharmacies = getData('pharmacies');
            const selectors = ['pharmacySelect', 'contactPharmacie', 'notePharmacie', 'messagePharmacie', 'checklistPharmacie', 'contactPharmacyFilter', 'checklistPharmacyFilter'];
            
            selectors.forEach(selectorId => {
                const selector = document.getElementById(selectorId);
                if (selector) {
                    // Save current value
                    const currentValue = selector.value;
                    
                    // Clear options (keep first option)
                    const firstOption = selector.firstElementChild;
                    selector.innerHTML = '';
                    if (firstOption) selector.appendChild(firstOption);
                    
                    // Add pharmacy options
                    pharmacies.forEach(pharmacy => {
                        const option = document.createElement('option');
                        option.value = pharmacy.id;
                        option.textContent = pharmacy.nom;
                        selector.appendChild(option);
                    });
                    
                    // Restore value
                    selector.value = currentValue;
                }
            });
            
            // Update current pharmacy selector
            document.getElementById('pharmacySelect').value = currentPharmacy;
            
            // Show/hide delete button
            const deleteBtn = document.getElementById('deletePharmacyBtn');
            if (deleteBtn) {
                deleteBtn.style.display = currentPharmacy ? 'block' : 'none';
            }
        }

        // Dashboard functions
        function updateCurrentDate() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            };
            document.getElementById('currentDate').textContent = now.toLocaleDateString('fr-FR', options);
        }

        function updateDashboard() {
            const contacts = getData('contacts').filter(c => !currentPharmacy || !c.pharmacie || c.pharmacie === currentPharmacy);
            const notes = getData('notes').filter(n => !currentPharmacy || !n.pharmacie || n.pharmacie === currentPharmacy);
            const messages = getData('messages').filter(m => !currentPharmacy || !m.pharmacie || m.pharmacie === currentPharmacy);
            const checklistItems = getData('checklist_items').filter(c => !currentPharmacy || !c.pharmacie || c.pharmacie === currentPharmacy);
            const pharmacies = getData('pharmacies');

            // Update stats
            document.getElementById('statContactsFavoris').textContent = contacts.filter(c => c.favori).length;
            document.getElementById('statNotes').textContent = notes.length;
            document.getElementById('statMessages').textContent = messages.length;
            document.getElementById('statPharmacies').textContent = pharmacies.length;
            
            const completedTasks = checklistItems.filter(c => c.complete).length;
            const totalTasks = checklistItems.length;
            document.getElementById('statTaches').textContent = `${completedTasks}/${totalTasks}`;
            document.getElementById('statTachesPercent').textContent = `${totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0}% compl√©t√©es`;

            // Update favorite contacts
            updateFavoriteContacts();
            
            // Update recent tasks - OPTIMIS√â POUR PLUS D'AFFICHAGE
            updateRecentTasks();
        }

        function updateFavoriteContacts() {
            const contacts = getData('contacts')
                .filter(c => c.favori && (!currentPharmacy || !c.pharmacie || c.pharmacie === currentPharmacy))
                .slice(0, 6);
            
            const container = document.getElementById('favoriteContacts');
            
            if (contacts.length === 0) {
                container.innerHTML = '<p class="text-muted text-center py-4">Aucun contact prioritaire</p>';
                return;
            }
            
            container.innerHTML = contacts.map(contact => {
                const phoneFavori = getPhoneFavori(contact);
                return `
                    <div class="contact-card favori mb-3">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-fill">
                                <div class="fw-bold">${contact.nom} ${contact.prenom || ''}</div>
                                ${contact.role ? `<div class="small text-muted">${contact.role}</div>` : ''}
                                ${phoneFavori ? `
                                    <div class="small text-primary fw-medium mt-1">
                                        üìû ${phoneFavori}
                                        <span class="text-muted ms-1">(${contact.telephones.favori})</span>
                                    </div>
                                ` : ''}
                            </div>
                            <i class="bi bi-star-fill text-warning"></i>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // FONCTION OPTIMIS√âE POUR AFFICHER PLUS DE T√ÇCHES
        function updateRecentTasks() {
            const checklistItems = getData('checklist_items')
                .filter(item => !item.complete && (!currentPharmacy || !item.pharmacie || item.pharmacie === currentPharmacy))
                .sort((a, b) => new Date(b.dateCreation).getTime() - new Date(a.dateCreation).getTime())
                .slice(0, 10); // Augment√© de 3 √† 10 t√¢ches
            
            const container = document.getElementById('recentTasks');
            const taskCountBadge = document.getElementById('taskCount');
            
            if (taskCountBadge) {
                taskCountBadge.textContent = checklistItems.length;
            }
            
            if (checklistItems.length === 0) {
                container.innerHTML = '<p class="text-muted text-center py-4">Aucune t√¢che en cours</p>';
                return;
            }
            
            container.innerHTML = checklistItems.map(task => `
                <div class="task-item p-3 bg-light rounded mb-2" 
                     onclick="editTaskFromDashboard('${task.id}')" 
                     title="Cliquez pour √©diter cette t√¢che">
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="task-title fw-medium text-dark">${task.titre}</span>
                        <span class="task-category badge bg-primary">${task.categorie}</span>
                    </div>
                    <div class="small text-muted mt-1">
                        Cr√©√©e le ${new Date(task.dateCreation).toLocaleDateString('fr-FR')}
                    </div>
                </div>
            `).join('');
        }

        // NOUVELLE FONCTION POUR √âDITER UNE T√ÇCHE DEPUIS LE TABLEAU DE BORD
        function editTaskFromDashboard(taskId) {
            const checklistItems = getData('checklist_items');
            const task = checklistItems.find(item => item.id === taskId);
            if (task) {
                editingChecklistId = taskId;
                openChecklistModal(task);
            }
        }

        function getPhoneFavori(contact) {
            if (!contact.telephones || !contact.telephones.favori) return '';
            return contact.telephones[contact.telephones.favori] || '';
        }

        // Quick actions - FONCTION MODIFI√âE POUR NOTE RAPIDE
        function quickNote() {
            openNoteModal();
        }

        function quickContact() {
            openContactModal();
        }

        function quickMessage() {
            openMessageModal();
        }

        function quickChecklist() {
            openChecklistModal();
        }

        // Medicine search
        function searchMedicines() {
            const query = document.getElementById('medicineSearch').value.toLowerCase();
            const resultsContainer = document.getElementById('medicineResults');
            
            if (!query || query.length < 2) {
                resultsContainer.innerHTML = '';
                return;
            }
            
            const results = medicineDatabase.filter(med => 
                med.name.toLowerCase().includes(query) ||
                med.manufacturer.toLowerCase().includes(query)
            );
            
            if (results.length === 0) {
                resultsContainer.innerHTML = '<div class="text-center py-3 text-muted">Aucun m√©dicament trouv√©</div>';
                return;
            }
            
            resultsContainer.innerHTML = results.map(med => `
                <div class="border rounded p-3 mb-2 ${med.available ? 'border-success bg-success' : 'border-danger bg-danger'} bg-opacity-10">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <div class="fw-bold">${med.name}</div>
                            <div class="small text-muted">${med.manufacturer} ‚Ä¢ ${med.type}</div>
                        </div>
                        <div class="text-end">
                            <div class="fw-bold fs-5">${med.price.toFixed(2)}‚Ç¨</div>
                            <span class="badge ${med.available ? 'bg-success' : 'bg-danger'}">
                                ${med.available ? 'Disponible' : 'Rupture'}
                            </span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function searchContactsByMedicine() {
            const query = document.getElementById('contactMedicineSearch').value.toLowerCase();
            const resultsContainer = document.getElementById('contactMedicineResults');
            
            if (!query) {
                resultsContainer.innerHTML = '';
                return;
            }
            
            const contacts = getData('contacts').filter(contact => 
                contact.medicament && 
                contact.medicament.toLowerCase().includes(query) &&
                (!currentPharmacy || !contact.pharmacie || contact.pharmacie === currentPharmacy)
            );
            
            if (contacts.length === 0) {
                resultsContainer.innerHTML = '<div class="col-12 text-center py-4 text-muted">Aucun contact trouv√© pour ce m√©dicament</div>';
                return;
            }
            
            resultsContainer.innerHTML = contacts.map(contact => `
                <div class="col-md-6">
                    <div class="contact-card ${contact.favori ? 'favori' : ''} ${contact.confidentiel ? 'confidentiel' : ''}">
                        <div class="d-flex align-items-center mb-2">
                            ${contact.favori ? '<i class="bi bi-star-fill text-warning me-2"></i>' : ''}
                            ${contact.confidentiel ? '<i class="bi bi-lock-fill text-danger me-2"></i>' : ''}
                            <h6 class="mb-0">${contact.nom} ${contact.prenom || ''}</h6>
                        </div>
                        ${contact.role ? `<p class="text-muted mb-2">${contact.role}</p>` : ''}
                        ${getPhoneFavori(contact) ? `
                            <div class="d-flex align-items-center text-primary fw-medium mb-2">
                                <i class="bi bi-telephone me-2"></i>
                                <span>${getPhoneFavori(contact)}</span>
                                <span class="text-muted ms-1">(${contact.telephones.favori})</span>
                            </div>
                        ` : ''}
                        ${contact.email ? `<p class="small text-muted mb-2">‚úâÔ∏è ${contact.email}</p>` : ''}
                        ${contact.medicament ? `<p class="small text-info mb-2">üíä ${contact.medicament}</p>` : ''}
                        ${contact.notes ? `<p class="small text-muted">${contact.notes}</p>` : ''}
                    </div>
                </div>
            `).join('');
        }

        // Contact management
        function openContactModal(contact = null) {
            editingContactId = contact ? contact.id : null;
            const modal = new bootstrap.Modal(document.getElementById('contactModal'));
            
            // Reset form
            document.getElementById('contactForm').reset();
            noteImages = [];
            
            // Update modal title and button
            document.querySelector('#contactModal .modal-title').textContent = contact ? 'Modifier le contact' : 'Nouveau contact';
            document.querySelector('#contactModal .btn-primary').textContent = contact ? 'Modifier' : 'Ajouter';
            
            // Populate form if editing
            if (contact) {
                document.getElementById('contactNom').value = contact.nom;
                document.getElementById('contactPrenom').value = contact.prenom || '';
                document.getElementById('contactRole').value = contact.role || '';
                document.getElementById('contactEmail').value = contact.email || '';
                document.getElementById('contactFixe').value = contact.telephones?.fixe || '';
                document.getElementById('contactGsm').value = contact.telephones?.gsm || '';
                document.getElementById('contactBureau').value = contact.telephones?.bureau || '';
                document.getElementById('contactMedicament').value = contact.medicament || '';
                document.getElementById('contactAdresse').value = contact.adresse || '';
                document.getElementById('contactNotes').value = contact.notes || '';
                document.getElementById('contactFavori').checked = contact.favori;
                document.getElementById('contactConfidentiel').checked = contact.confidentiel;
                document.getElementById('contactPharmacie').value = contact.pharmacie || '';
            } else {
                document.getElementById('contactPharmacie').value = currentPharmacy;
            }
            
            updatePhoneFavoriOptions();
            modal.show();
        }

        function updatePhoneFavoriOptions() {
            const fixe = document.getElementById('contactFixe').value;
            const gsm = document.getElementById('contactGsm').value;
            const bureau = document.getElementById('contactBureau').value;
            const favoriSelect = document.getElementById('contactTelFavori');
            
            const currentValue = favoriSelect.value;
            favoriSelect.innerHTML = '<option value="">Aucun t√©l√©phone favori</option>';
            
            if (fixe) {
                const option = document.createElement('option');
                option.value = 'fixe';
                option.textContent = `Fixe: ${fixe}`;
                favoriSelect.appendChild(option);
            }
            if (gsm) {
                const option = document.createElement('option');
                option.value = 'gsm';
                option.textContent = `GSM: ${gsm}`;
                favoriSelect.appendChild(option);
            }
            if (bureau) {
                const option = document.createElement('option');
                option.value = 'bureau';
                option.textContent = `Bureau: ${bureau}`;
                favoriSelect.appendChild(option);
            }
            
            favoriSelect.value = currentValue;
        }

        // Add event listeners for phone fields
        document.addEventListener('DOMContentLoaded', function() {
            ['contactFixe', 'contactGsm', 'contactBureau'].forEach(id => {
                const field = document.getElementById(id);
                if (field) {
                    field.addEventListener('input', updatePhoneFavoriOptions);
                }
            });
        });

        function saveContact() {
            const form = document.getElementById('contactForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            const contactData = {
                nom: document.getElementById('contactNom').value,
                prenom: document.getElementById('contactPrenom').value,
                role: document.getElementById('contactRole').value,
                telephones: {
                    fixe: document.getElementById('contactFixe').value,
                    gsm: document.getElementById('contactGsm').value,
                    bureau: document.getElementById('contactBureau').value,
                    favori: document.getElementById('contactTelFavori').value,
                },
                email: document.getElementById('contactEmail').value,
                adresse: document.getElementById('contactAdresse').value,
                notes: document.getElementById('contactNotes').value,
                medicament: document.getElementById('contactMedicament').value,
                favori: document.getElementById('contactFavori').checked,
                confidentiel: document.getElementById('contactConfidentiel').checked,
                pharmacie: document.getElementById('contactPharmacie').value,
            };
            
            const contacts = getData('contacts');
            
            if (editingContactId) {
                // Update existing contact
                const index = contacts.findIndex(c => c.id === editingContactId);
                if (index !== -1) {
                    contacts[index] = { ...contacts[index], ...contactData };
                }
            } else {
                // Add new contact
                const newContact = {
                    ...contactData,
                    id: Date.now().toString(),
                    dateCreation: new Date().toISOString(),
                };
                contacts.push(newContact);
            }
            
            setData('contacts', contacts);
            bootstrap.Modal.getInstance(document.getElementById('contactModal')).hide();
            showNotification(editingContactId ? 'Contact modifi√©' : 'Contact ajout√©');
            
            if (currentPage === 'contacts') loadContacts();
            updateDashboard();
        }

        function loadContacts() {
            const contacts = getData('contacts').filter(c => !currentPharmacy || !c.pharmacie || c.pharmacie === currentPharmacy);
            updateContactFilters();
            filterContacts();
        }

        function updateContactFilters() {
            const contacts = getData('contacts');
            
            // Update pharmacy filter
            const pharmacyFilter = document.getElementById('contactPharmacyFilter');
            const currentValue = pharmacyFilter.value;
            // Keep first option and pharmacy options are already updated by updatePharmacySelectors
            pharmacyFilter.value = currentValue;
            
            // Update contact filters for other selectors
            updateContactSelectors();
        }

        function updateContactSelectors() {
            const contacts = getData('contacts');
            const selectors = ['noteContact', 'messageContactFilter'];
            
            selectors.forEach(selectorId => {
                const selector = document.getElementById(selectorId);
                if (selector) {
                    const currentValue = selector.value;
                    const firstOption = selector.firstElementChild;
                    selector.innerHTML = '';
                    if (firstOption) selector.appendChild(firstOption);
                    
                    contacts.forEach(contact => {
                        const option = document.createElement('option');
                        option.value = contact.id;
                        option.textContent = `${contact.nom} ${contact.prenom || ''}`;
                        selector.appendChild(option);
                    });
                    
                    selector.value = currentValue;
                }
            });
        }

        function filterContacts() {
            const searchTerm = document.getElementById('contactSearch').value.toLowerCase();
            const typeFilter = document.getElementById('contactTypeFilter').value;
            const pharmacyFilter = document.getElementById('contactPharmacyFilter').value;
            
            let contacts = getData('contacts').filter(contact => {
                if (currentPharmacy && contact.pharmacie && contact.pharmacie !== currentPharmacy) {
                    return false;
                }
                
                const matchesSearch = !searchTerm || 
                    contact.nom.toLowerCase().includes(searchTerm) ||
                    (contact.prenom && contact.prenom.toLowerCase().includes(searchTerm)) ||
                    (contact.role && contact.role.toLowerCase().includes(searchTerm)) ||
                    (contact.medicament && contact.medicament.toLowerCase().includes(searchTerm));
                
                const matchesFilter = !typeFilter || 
                    (typeFilter === 'favoris' && contact.favori) ||
                    (typeFilter === 'confidentiels' && contact.confidentiel);
                
                const matchesPharmacy = !pharmacyFilter || contact.pharmacie === pharmacyFilter;
                
                return matchesSearch && matchesFilter && matchesPharmacy;
            });
            
            document.getElementById('contactCount').textContent = `${contacts.length} contact(s)`;
            
            const container = document.getElementById('contactsList');
            
            if (contacts.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="bi bi-people display-1 text-muted"></i>
                        <h3 class="mt-3">Aucun contact</h3>
                        <p class="text-muted">Commencez par ajouter votre premier contact</p>
                        <button class="btn btn-primary" onclick="openContactModal()">
                            <i class="bi bi-plus"></i> Ajouter un contact
                        </button>
                    </div>
                `;
                return;
            }
            
            // Separate favorites and regular contacts
            const favoriteContacts = contacts.filter(c => c.favori);
            const regularContacts = contacts.filter(c => !c.favori);
            
            let html = '';
            
            if (favoriteContacts.length > 0) {
                html += `
                    <div class="mb-4">
                        <h4 class="d-flex align-items-center mb-3">
                            <i class="bi bi-star-fill text-warning me-2"></i>
                            Contacts favoris
                        </h4>
                        <div class="row g-3">
                            ${favoriteContacts.map(contact => renderContactCard(contact)).join('')}
                        </div>
                    </div>
                `;
            }
            
            if (regularContacts.length > 0) {
                html += `
                    <div>
                        <h4 class="d-flex align-items-center mb-3">
                            <i class="bi bi-people me-2"></i>
                            Tous les contacts
                        </h4>
                        <div class="row g-3">
                            ${regularContacts.map(contact => renderContactCard(contact)).join('')}
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }

        function renderContactCard(contact) {
            const phoneFavori = getPhoneFavori(contact);
            return `
                <div class="col-md-6 col-lg-4">
                    <div class="contact-card ${contact.favori ? 'favori' : ''} ${contact.confidentiel ? 'confidentiel' : ''} h-100">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div class="flex-fill">
                                <div class="d-flex align-items-center mb-2">
                                    ${contact.favori ? '<i class="bi bi-star-fill text-warning me-2"></i>' : ''}
                                    ${contact.confidentiel ? '<i class="bi bi-lock-fill text-danger me-2"></i>' : ''}
                                    <h6 class="mb-0">${contact.nom} ${contact.prenom || ''}</h6>
                                </div>
                                ${contact.role ? `<p class="text-muted mb-2">${contact.role}</p>` : ''}
                                
                                <!-- Phone numbers -->
                                <div class="mb-2">
                                    ${contact.telephones?.fixe ? `
                                        <div class="small d-flex align-items-center ${contact.telephones.favori === 'fixe' ? 'text-primary fw-bold' : 'text-muted'}">
                                            <i class="bi bi-telephone me-1"></i>
                                            <span>Fixe: ${contact.telephones.fixe}</span>
                                            ${contact.telephones.favori === 'fixe' ? '<i class="bi bi-star-fill text-warning ms-1"></i>' : ''}
                                        </div>
                                    ` : ''}
                                    ${contact.telephones?.gsm ? `
                                        <div class="small d-flex align-items-center ${contact.telephones.favori === 'gsm' ? 'text-primary fw-bold' : 'text-muted'}">
                                            <i class="bi bi-telephone me-1"></i>
                                            <span>GSM: ${contact.telephones.gsm}</span>
                                            ${contact.telephones.favori === 'gsm' ? '<i class="bi bi-star-fill text-warning ms-1"></i>' : ''}
                                        </div>
                                    ` : ''}
                                    ${contact.telephones?.bureau ? `
                                        <div class="small d-flex align-items-center ${contact.telephones.favori === 'bureau' ? 'text-primary fw-bold' : 'text-muted'}">
                                            <i class="bi bi-telephone me-1"></i>
                                            <span>Bureau: ${contact.telephones.bureau}</span>
                                            ${contact.telephones.favori === 'bureau' ? '<i class="bi bi-star-fill text-warning ms-1"></i>' : ''}
                                        </div>
                                    ` : ''}
                                </div>
                                
                                ${contact.email ? `<p class="small text-muted mb-2">‚úâÔ∏è ${contact.email}</p>` : ''}
                                ${contact.medicament ? `<p class="small text-info mb-2">üíä ${contact.medicament}</p>` : ''}
                                ${contact.notes ? `<p class="small text-muted">${contact.notes}</p>` : ''}
                            </div>
                            <div class="d-flex flex-column gap-2">
                                <button class="btn btn-sm btn-outline-primary" onclick="openContactModal(${JSON.stringify(contact).replace(/"/g, '&quot;')})" title="Modifier">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteContact('${contact.id}')" title="Supprimer">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function deleteContact(id) {
            const contacts = getData('contacts');
            const contact = contacts.find(c => c.id === id);
            if (contact && confirm(`√ätes-vous s√ªr de vouloir supprimer le contact "${contact.nom}" ?`)) {
                const updatedContacts = contacts.filter(c => c.id !== id);
                setData('contacts', updatedContacts);
                showNotification('Contact supprim√©');
                if (currentPage === 'contacts') loadContacts();
                updateDashboard();
            }
        }

        // Note management
        function openNoteModal(note = null) {
            editingNoteId = note ? note.id : null;
            const modal = new bootstrap.Modal(document.getElementById('noteModal'));
            
            // Reset form
            document.getElementById('noteForm').reset();
            noteImages = [];
            document.getElementById('noteImagePreviews').innerHTML = '';
            
            // Update modal title and button
            document.querySelector('#noteModal .modal-title').textContent = note ? 'Modifier la note' : 'Nouvelle note';
            document.querySelector('#noteModal .btn-primary').textContent = note ? 'Modifier' : 'Ajouter';
            
            // Populate form if editing
            if (note) {
                document.getElementById('noteTitre').value = note.titre || '';
                document.getElementById('noteContenu').value = note.contenu;
                document.getElementById('noteTags').value = note.tags || '';
                document.getElementById('noteContact').value = note.contactAssocie || '';
                document.getElementById('notePharmacie').value = note.pharmacie || '';
                noteImages = note.images || [];
                displayNoteImages();
            } else {
                document.getElementById('notePharmacie').value = currentPharmacy;
            }
            
            updateContactSelectors();
            modal.show();
        }

        function handleNoteImages() {
            const files = document.getElementById('noteImages').files;
            const maxFiles = 5;
            const maxSize = 1024 * 1024; // 1MB
            
            if (noteImages.length + files.length > maxFiles) {
                alert(`Maximum ${maxFiles} images autoris√©es`);
                return;
            }
            
            Array.from(files).forEach(file => {
                if (file.size > maxSize) {
                    alert(`Image trop volumineuse: ${file.name}`);
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    noteImages.push(e.target.result);
                    displayNoteImages();
                };
                reader.readAsDataURL(file);
            });
        }

        function displayNoteImages() {
            const container = document.getElementById('noteImagePreviews');
            container.innerHTML = noteImages.map((img, index) => `
                <div class="d-inline-block position-relative me-2 mb-2">
                    <img src="${img}" alt="Image ${index + 1}" class="img-thumbnail" style="width: 100px; height: 100px; object-fit: cover;">
                    <button type="button" class="btn btn-danger btn-sm position-absolute top-0 end-0" onclick="removeNoteImage(${index})">
                        <i class="bi bi-x"></i>
                    </button>
                </div>
            `).join('');
        }

        function removeNoteImage(index) {
            noteImages.splice(index, 1);
            displayNoteImages();
        }

        function saveNote() {
            const form = document.getElementById('noteForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            const noteData = {
                titre: document.getElementById('noteTitre').value,
                contenu: document.getElementById('noteContenu').value,
                tags: document.getElementById('noteTags').value,
                contactAssocie: document.getElementById('noteContact').value,
                images: noteImages,
                pharmacie: document.getElementById('notePharmacie').value,
            };
            
            const notes = getData('notes');
            
            if (editingNoteId) {
                // Update existing note
                const index = notes.findIndex(n => n.id === editingNoteId);
                if (index !== -1) {
                    notes[index] = { ...notes[index], ...noteData };
                }
            } else {
                // Add new note
                const newNote = {
                    ...noteData,
                    id: Date.now().toString(),
                    dateCreation: new Date().toISOString(),
                };
                notes.push(newNote);
            }
            
            setData('notes', notes);
            bootstrap.Modal.getInstance(document.getElementById('noteModal')).hide();
            showNotification(editingNoteId ? 'Note modifi√©e' : 'Note ajout√©e');
            
            if (currentPage === 'notes') loadNotes();
            updateDashboard();
        }

        function loadNotes() {
            const notes = getData('notes').filter(n => !currentPharmacy || !n.pharmacie || n.pharmacie === currentPharmacy);
            updateNoteFilters();
            filterNotes();
        }

        function updateNoteFilters() {
            const notes = getData('notes');
            
            // Update tag filter
            const tagFilter = document.getElementById('noteTagFilter');
            const currentTagValue = tagFilter.value;
            tagFilter.innerHTML = '<option value="">Tous les tags</option>';
            
            const tags = new Set();
            notes.forEach(note => {
                if (note.tags) {
                    note.tags.split(',').forEach(tag => tags.add(tag.trim()));
                }
            });
            
            Array.from(tags).forEach(tag => {
                const option = document.createElement('option');
                option.value = tag;
                option.textContent = tag;
                tagFilter.appendChild(option);
            });
            
            tagFilter.value = currentTagValue;
        }

        function filterNotes() {
            const searchTerm = document.getElementById('noteSearch').value.toLowerCase();
            const tagFilter = document.getElementById('noteTagFilter').value;
            const contactFilter = document.getElementById('noteContactFilter').value;
            
            let notes = getData('notes').filter(note => {
                if (currentPharmacy && note.pharmacie && note.pharmacie !== currentPharmacy) {
                    return false;
                }
                
                const matchesSearch = !searchTerm || 
                    (note.titre && note.titre.toLowerCase().includes(searchTerm)) ||
                    note.contenu.toLowerCase().includes(searchTerm);
                
                const matchesTag = !tagFilter || 
                    (note.tags && note.tags.toLowerCase().includes(tagFilter.toLowerCase()));
                
                const matchesContact = !contactFilter || note.contactAssocie === contactFilter;
                
                return matchesSearch && matchesTag && matchesContact;
            });
            
            document.getElementById('noteCount').textContent = `${notes.length} note(s)`;
            
            const container = document.getElementById('notesList');
            
            if (notes.length === 0) {
                container.innerHTML = `
                    <div class="col-12">
                        <div class="text-center py-5">
                            <i class="bi bi-journal-text display-1 text-muted"></i>
                            <h3 class="mt-3">Aucune note</h3>
                            <p class="text-muted">Commencez par cr√©er votre premi√®re note</p>
                            <button class="btn btn-primary" onclick="openNoteModal()">
                                <i class="bi bi-plus"></i> Cr√©er une note
                            </button>
                        </div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = notes.map(note => renderNoteCard(note)).join('');
        }

        function renderNoteCard(note) {
            const contacts = getData('contacts');
            const contact = contacts.find(c => c.id === note.contactAssocie);
            const contactName = contact ? `${contact.nom} ${contact.prenom || ''}`.trim() : '';
            
            return `
                <div class="col-md-6 col-lg-4">
                    <div class="card h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <h6 class="card-title">${note.titre || 'Note sans titre'}</h6>
                                <div class="d-flex gap-1">
                                    <button class="btn btn-sm btn-outline-primary" onclick="openNoteModal(${JSON.stringify(note).replace(/"/g, '&quot;')})" title="Modifier">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteNote('${note.id}')" title="Supprimer">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <p class="card-text text-muted small" style="display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden;">
                                ${note.contenu}
                            </p>

                            ${note.images && note.images.length > 0 ? `
                                <div class="mb-3">
                                    <div class="d-flex align-items-center mb-2">
                                        <i class="bi bi-image me-2 text-muted"></i>
                                        <small class="text-muted">${note.images.length} image(s)</small>
                                    </div>
                                    <div class="d-flex gap-1">
                                        ${note.images.slice(0, 3).map((img, index) => `
                                            <img src="${img}" alt="Image ${index + 1}" class="img-thumbnail" style="width: 50px; height: 50px; object-fit: cover; cursor: pointer;" onclick="window.open('${img}', '_blank')">
                                        `).join('')}
                                        ${note.images.length > 3 ? `
                                            <div class="d-flex align-items-center justify-content-center bg-light border rounded" style="width: 50px; height: 50px;">
                                                <small class="text-muted">+${note.images.length - 3}</small>
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${note.tags ? `
                                <div class="mb-3">
                                    ${note.tags.split(',').map(tag => `
                                        <span class="note-tag me-1">${tag.trim()}</span>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                        <div class="card-footer bg-transparent">
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted">${new Date(note.dateCreation).toLocaleDateString('fr-FR')}</small>
                                ${contactName ? `<small class="text-primary">üë§ ${contactName}</small>` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function deleteNote(id) {
            const notes = getData('notes');
            const note = notes.find(n => n.id === id);
            if (note && confirm('√ätes-vous s√ªr de vouloir supprimer cette note ?')) {
                const updatedNotes = notes.filter(n => n.id !== id);
                setData('notes', updatedNotes);
                showNotification('Note supprim√©e');
                if (currentPage === 'notes') loadNotes();
                updateDashboard();
            }
        }

        function exportNotesPDF() {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF();
            const pageWidth = pdf.internal.pageSize.getWidth();
            const pageHeight = pdf.internal.pageSize.getHeight();
            let yPosition = 20;

            // Title
            pdf.setFontSize(20);
            pdf.setFont('helvetica', 'bold');
            pdf.text('PharmaBoard+ - Export des Notes', pageWidth / 2, yPosition, { align: 'center' });
            yPosition += 15;

            // Export date
            pdf.setFontSize(10);
            pdf.setFont('helvetica', 'normal');
            pdf.text(`Export√© le ${new Date().toLocaleDateString('fr-FR')}`, pageWidth / 2, yPosition, { align: 'center' });
            yPosition += 20;

            // Notes
            const notes = getData('notes').filter(n => !currentPharmacy || !n.pharmacie || n.pharmacie === currentPharmacy);
            const contacts = getData('contacts');
            
            notes.forEach((note, index) => {
                if (yPosition > pageHeight - 40) {
                    pdf.addPage();
                    yPosition = 20;
                }

                // Note title
                pdf.setFontSize(14);
                pdf.setFont('helvetica', 'bold');
                const title = note.titre || `Note ${index + 1}`;
                pdf.text(title, 20, yPosition);
                yPosition += 10;

                // Date and contact
                pdf.setFontSize(9);
                pdf.setFont('helvetica', 'normal');
                const dateText = `Date: ${new Date(note.dateCreation).toLocaleDateString('fr-FR')}`;
                pdf.text(dateText, 20, yPosition);
                
                if (note.contactAssocie) {
                    const contact = contacts.find(c => c.id === note.contactAssocie);
                    const contactText = contact ? `Contact: ${contact.nom} ${contact.prenom || ''}` : '';
                    if (contactText) {
                        pdf.text(contactText, 100, yPosition);
                    }
                }
                yPosition += 8;

                // Tags
                if (note.tags) {
                    pdf.setFontSize(8);
                    pdf.text(`Tags: ${note.tags}`, 20, yPosition);
                    yPosition += 8;
                }

                // Content
                pdf.setFontSize(10);
                pdf.setFont('helvetica', 'normal');
                const lines = pdf.splitTextToSize(note.contenu, pageWidth - 40);
                
                lines.forEach(line => {
                    if (yPosition > pageHeight - 20) {
                        pdf.addPage();
                        yPosition = 20;
                    }
                    pdf.text(line, 20, yPosition);
                    yPosition += 5;
                });

                // Images mention
                if (note.images && note.images.length > 0) {
                    pdf.setFontSize(8);
                    pdf.setFont('helvetica', 'italic');
                    pdf.text(`[${note.images.length} image(s) associ√©e(s)]`, 20, yPosition);
                    yPosition += 8;
                }

                yPosition += 10; // Space between notes
            });

            // Save
            const filename = `PharmaBoard_Notes_${new Date().toISOString().split('T')[0]}.pdf`;
            pdf.save(filename);
            showNotification('Notes export√©es en PDF avec succ√®s');
        }

        // Message management
        function openMessageModal(message = null) {
            editingMessageId = message ? message.id : null;
            const modal = new bootstrap.Modal(document.getElementById('messageModal'));
            
            // Reset form
            document.getElementById('messageForm').reset();
            
            // Update modal title and button
            document.querySelector('#messageModal .modal-title').textContent = message ? 'Modifier le message' : 'Nouveau message';
            document.querySelector('#messageModal .btn-primary').textContent = message ? 'Modifier' : 'Envoyer';
            
            // Populate form if editing
            if (message) {
                document.getElementById('messageType').value = message.type;
                document.getElementById('messageUrgent').checked = message.urgent;
                document.getElementById('messageSujet').value = message.sujet;
                document.getElementById('messageContenu').value = message.contenu;
                document.getElementById('messagePharmacie').value = message.pharmacie || '';
                
                // Set recipient type
                document.getElementById(`dest${message.typeDestinataires.charAt(0).toUpperCase() + message.typeDestinataires.slice(1)}`).checked = true;
            } else {
                document.getElementById('messagePharmacie').value = currentPharmacy;
                document.getElementById('destSelection').checked = true;
            }
            
            updateContactSelection();
            modal.show();
        }

        function updateContactSelection() {
            const contacts = getData('contacts').filter(c => !currentPharmacy || !c.pharmacie || c.pharmacie === currentPharmacy);
            const container = document.getElementById('contactSelection');
            
            container.innerHTML = contacts.map(contact => `
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="contact_${contact.id}" value="${contact.id}" onchange="updateDestinataireCount()">
                    <label class="form-check-label" for="contact_${contact.id}">
                        ${contact.favori ? '‚≠ê' : ''} ${contact.nom} ${contact.prenom || ''}
                        ${contact.role ? `<small class="text-muted d-block">${contact.role}</small>` : ''}
                    </label>
                </div>
            `).join('');
            
            updateDestinataireCount();
        }

        function updateDestinataireCount() {
            const destType = document.querySelector('input[name="destinataireType"]:checked').value;
            const contacts = getData('contacts').filter(c => !currentPharmacy || !c.pharmacie || c.pharmacie === currentPharmacy);
            let count = 0;
            
            if (destType === 'tous') {
                count = contacts.length;
            } else if (destType === 'favoris') {
                count = contacts.filter(c => c.favori).length;
            } else {
                count = document.querySelectorAll('#contactSelection input:checked').length;
            }
            
            document.getElementById('destinataireCount').textContent = count;
        }

        // Add event listeners for recipient type radio buttons
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('input[name="destinataireType"]').forEach(radio => {
                radio.addEventListener('change', updateDestinataireCount);
            });
        });

        function saveMessage() {
            const form = document.getElementById('messageForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            const destType = document.querySelector('input[name="destinataireType"]:checked').value;
            const contacts = getData('contacts').filter(c => !currentPharmacy || !c.pharmacie || c.pharmacie === currentPharmacy);
            let destinataires = [];
            
            if (destType === 'tous') {
                destinataires = contacts.map(c => c.id);
            } else if (destType === 'favoris') {
                destinataires = contacts.filter(c => c.favori).map(c => c.id);
            } else {
                destinataires = Array.from(document.querySelectorAll('#contactSelection input:checked')).map(cb => cb.value);
            }
            
            if (destinataires.length === 0 && destType === 'selection') {
                alert('Veuillez s√©lectionner au moins un destinataire');
                return;
            }
            
            const messageData = {
                type: document.getElementById('messageType').value,
                destinataires: destinataires,
                typeDestinataires: destType,
                sujet: document.getElementById('messageSujet').value,
                contenu: document.getElementById('messageContenu').value,
                urgent: document.getElementById('messageUrgent').checked,
                pharmacie: document.getElementById('messagePharmacie').value,
            };
            
            const messages = getData('messages');
            
            if (editingMessageId) {
                // Update existing message
                const index = messages.findIndex(m => m.id === editingMessageId);
                if (index !== -1) {
                    messages[index] = { ...messages[index], ...messageData };
                }
            } else {
                // Add new message
                const newMessage = {
                    ...messageData,
                    id: Date.now().toString(),
                    dateCreation: new Date().toISOString(),
                };
                messages.push(newMessage);
            }
            
            setData('messages', messages);
            bootstrap.Modal.getInstance(document.getElementById('messageModal')).hide();
            showNotification(editingMessageId ? 'Message modifi√©' : 'Message envoy√©');
            
            if (currentPage === 'messages') loadMessages();
            updateDashboard();
        }

        function loadMessages() {
            const messages = getData('messages').filter(m => !currentPharmacy || !m.pharmacie || m.pharmacie === currentPharmacy);
            filterMessages();
        }

        function filterMessages() {
            const searchTerm = document.getElementById('messageSearch').value.toLowerCase();
            const typeFilter = document.getElementById('messageTypeFilter').value;
            const contactFilter = document.getElementById('messageContactFilter').value;
            
            let messages = getData('messages').filter(message => {
                if (currentPharmacy && message.pharmacie && message.pharmacie !== currentPharmacy) {
                    return false;
                }
                
                const matchesSearch = !searchTerm || 
                    message.sujet.toLowerCase().includes(searchTerm) ||
                    message.contenu.toLowerCase().includes(searchTerm);
                
                const matchesType = !typeFilter || message.type === typeFilter;
                
                const matchesContact = !contactFilter || 
                    message.destinataires.includes(contactFilter);
                
                return matchesSearch && matchesType && matchesContact;
            });
            
            document.getElementById('messageCount').textContent = `${messages.length} message(s)`;
            
            const container = document.getElementById('messagesList');
            
            if (messages.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="bi bi-chat-dots display-1 text-muted"></i>
                        <h3 class="mt-3">Aucun message</h3>
                        <p class="text-muted">Commencez par cr√©er votre premier message</p>
                        <button class="btn btn-primary" onclick="openMessageModal()">
                            <i class="bi bi-plus"></i> Nouveau message
                        </button>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = messages.map(message => renderMessageCard(message)).join('');
        }

        function renderMessageCard(message) {
            const contacts = getData('contacts');
            const getContactName = (contactId) => {
                const contact = contacts.find(c => c.id === contactId);
                return contact ? `${contact.nom} ${contact.prenom || ''}`.trim() : 'Contact inconnu';
            };
            
            const getDestinatairesDisplay = () => {
                if (message.typeDestinataires === 'tous') {
                    return 'Tous les contacts';
                } else if (message.typeDestinataires === 'favoris') {
                    return 'Contacts favoris';
                } else {
                    return message.destinataires.map(id => getContactName(id)).join(', ');
                }
            };
            
            const getMessageTypeBadge = (type) => {
                const badges = {
                    'email': 'bg-primary',
                    'sms': 'bg-success',
                    'note': 'bg-secondary'
                };
                return badges[type] || 'bg-secondary';
            };
            
            const getMessageTypeLabel = (type) => {
                const labels = {
                    'email': 'Email',
                    'sms': 'SMS',
                    'note': 'Note interne'
                };
                return labels[type] || type;
            };
            
            return `
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-fill">
                                <div class="d-flex align-items-center mb-3">
                                    <span class="badge ${getMessageTypeBadge(message.type)} me-2">
                                        ${getMessageTypeLabel(message.type)}
                                    </span>
                                    ${message.urgent ? '<span class="badge bg-danger me-2">üö® Urgent</span>' : ''}
                                </div>
                                
                                <h5 class="card-title">${message.sujet}</h5>
                                
                                <p class="card-text text-muted" style="display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden;">
                                    ${message.contenu}
                                </p>
                                
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="d-flex align-items-center gap-3">
                                        <small class="text-muted">üìÖ ${new Date(message.dateCreation).toLocaleDateString('fr-FR')}</small>
                                        <small class="text-muted">üë• ${getDestinatairesDisplay()}</small>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="d-flex gap-2">
                                <button class="btn btn-sm btn-outline-primary" onclick="openMessageModal(${JSON.stringify(message).replace(/"/g, '&quot;')})" title="Modifier">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteMessage('${message.id}')" title="Supprimer">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function deleteMessage(id) {
            const messages = getData('messages');
            const message = messages.find(m => m.id === id);
            if (message && confirm('√ätes-vous s√ªr de vouloir supprimer ce message ?')) {
                const updatedMessages = messages.filter(m => m.id !== id);
                setData('messages', updatedMessages);
                showNotification('Message supprim√©');
                if (currentPage === 'messages') loadMessages();
                updateDashboard();
            }
        }

        // Checklist management - FONCTION CORRIG√âE POUR LA SUPPRESSION
        function openChecklistModal(item = null) {
            editingChecklistId = item ? item.id : null;
            const modal = new bootstrap.Modal(document.getElementById('checklistModal'));
            
            // Reset form
            document.getElementById('checklistForm').reset();
            checklistImages = [];
            tableData = { colonnes: [], lignes: [] };
            document.getElementById('checklistImagePreviews').innerHTML = '';
            document.getElementById('tableContainer').innerHTML = '<p class="text-muted text-center py-3">Aucun tableau. Cliquez sur "Ajouter colonne" pour commencer.</p>';
            
            // Update modal title and button
            document.querySelector('#checklistModal .modal-title').textContent = item ? 'Modifier la checklist' : 'Nouvelle checklist';
            document.querySelector('#checklistModal .btn-primary').textContent = item ? 'Modifier' : 'Ajouter';
            
            // Populate form if editing
            if (item) {
                document.getElementById('checklistTitre').value = item.titre;
                document.getElementById('checklistCategorie').value = item.categorie;
                document.getElementById('checklistContenu').value = item.contenu;
                document.getElementById('checklistFavori').checked = item.favori;
                document.getElementById('checklistComplete').checked = item.complete;
                document.getElementById('checklistPharmacie').value = item.pharmacie || '';
                checklistImages = item.images || [];
                tableData = item.tableau || { colonnes: [], lignes: [] };
                displayChecklistImages();
                displayTable();
            } else {
                document.getElementById('checklistPharmacie').value = currentPharmacy;
            }
            
            modal.show();
        }

        function handleChecklistImages() {
            const files = document.getElementById('checklistImages').files;
            const maxFiles = 5;
            const maxSize = 1024 * 1024; // 1MB
            
            if (checklistImages.length + files.length > maxFiles) {
                alert(`Maximum ${maxFiles} images autoris√©es`);
                return;
            }
            
            Array.from(files).forEach(file => {
                if (file.size > maxSize) {
                    alert(`Image trop volumineuse: ${file.name}`);
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    checklistImages.push(e.target.result);
                    displayChecklistImages();
                };
                reader.readAsDataURL(file);
            });
        }

        function displayChecklistImages() {
            const container = document.getElementById('checklistImagePreviews');
            container.innerHTML = checklistImages.map((img, index) => `
                <div class="d-inline-block position-relative me-2 mb-2">
                    <img src="${img}" alt="Image ${index + 1}" class="img-thumbnail" style="width: 100px; height: 100px; object-fit: cover;">
                    <button type="button" class="btn btn-danger btn-sm position-absolute top-0 end-0" onclick="removeChecklistImage(${index})">
                        <i class="bi bi-x"></i>
                    </button>
                </div>
            `).join('');
        }

        function removeChecklistImage(index) {
            checklistImages.splice(index, 1);
            displayChecklistImages();
        }

        function addTableColumn() {
            const columnName = prompt('Nom de la colonne:');
            if (columnName?.trim()) {
                tableData.colonnes.push(columnName.trim());
                tableData.lignes.forEach(row => row.push(''));
                displayTable();
            }
        }

        function addTableRow() {
            if (tableData.colonnes.length === 0) {
                alert('Ajoutez d\'abord des colonnes');
                return;
            }
            tableData.lignes.push(new Array(tableData.colonnes.length).fill(''));
            displayTable();
        }

        function clearTable() {
            tableData = { colonnes: [], lignes: [] };
            displayTable();
        }

        function displayTable() {
            const container = document.getElementById('tableContainer');
            
            if (tableData.colonnes.length === 0) {
                container.innerHTML = '<p class="text-muted text-center py-3">Aucun tableau. Cliquez sur "Ajouter colonne" pour commencer.</p>';
                return;
            }
            
            let html = '<div class="table-responsive"><table class="table table-dark table-bordered">';
            
            // Header
            html += '<thead><tr>';
            tableData.colonnes.forEach((col, index) => {
                html += `<th><input type="text" class="form-control bg-transparent border-0 text-center fw-bold text-white" value="${col}" onchange="updateColumnName(${index}, this.value)"></th>`;
            });
            html += '</tr></thead>';
            
            // Body
            html += '<tbody>';
            tableData.lignes.forEach((row, rowIndex) => {
                html +=  '<tr>';
                row.forEach((cell, cellIndex) => {
                    html += `<td><input type="text" class="form-control bg-transparent border-0 text-white" value="${cell}" onchange="updateCellValue(${rowIndex}, ${cellIndex}, this.value)"></td>`;
                });
                html += '</tr>';
            });
            html += '</tbody>';
            
            html += '</table></div>';
            container.innerHTML = html;
        }

        function updateColumnName(index, value) {
            tableData.colonnes[index] = value;
        }

        function updateCellValue(rowIndex, cellIndex, value) {
            tableData.lignes[rowIndex][cellIndex] = value;
        }

        // FONCTION DE SAUVEGARDE CORRIG√âE POUR CHECKLIST
        function saveChecklist() {
            const form = document.getElementById('checklistForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            const checklistData = {
                titre: document.getElementById('checklistTitre').value,
                categorie: document.getElementById('checklistCategorie').value,
                contenu: document.getElementById('checklistContenu').value,
                images: checklistImages,
                tableau: tableData,
                favori: document.getElementById('checklistFavori').checked,
                complete: document.getElementById('checklistComplete').checked,
                pharmacie: document.getElementById('checklistPharmacie').value,
            };
            
            const checklistItems = getData('checklist_items');
            
            if (editingChecklistId) {
                // Update existing item
                const index = checklistItems.findIndex(c => c.id === editingChecklistId);
                if (index !== -1) {
                    checklistItems[index] = { ...checklistItems[index], ...checklistData };
                }
            } else {
                // Add new item
                const newItem = {
                    ...checklistData,
                    id: Date.now().toString(),
                    dateCreation: new Date().toISOString(),
                };
                checklistItems.push(newItem);
            }
            
            setData('checklist_items', checklistItems);
            bootstrap.Modal.getInstance(document.getElementById('checklistModal')).hide();
            showNotification(editingChecklistId ? 'Checklist modifi√©e' : 'Checklist ajout√©e');
            
            if (currentPage === 'checklist') loadChecklist();
            updateDashboard();
        }

        function loadChecklist() {
            const checklistItems = getData('checklist_items').filter(c => !currentPharmacy || !c.pharmacie || c.pharmacie === currentPharmacy);
            filterChecklist();
        }

        function filterChecklist() {
            const searchTerm = document.getElementById('checklistSearch').value.toLowerCase();
            const categoryFilter = document.getElementById('checklistCategoryFilter').value;
            const statusFilter = document.getElementById('checklistStatusFilter').value;
            const pharmacyFilter = document.getElementById('checklistPharmacyFilter').value;
            
            let checklistItems = getData('checklist_items').filter(item => {
                if (currentPharmacy && item.pharmacie && item.pharmacie !== currentPharmacy) {
                    return false;
                }
                
                const matchesSearch = !searchTerm || 
                    item.titre.toLowerCase().includes(searchTerm) ||
                    item.contenu.toLowerCase().includes(searchTerm);
                
                const matchesCategory = !categoryFilter || item.categorie === categoryFilter;
                
                const matchesStatus = !statusFilter || 
                    (statusFilter === 'completed' && item.complete) ||
                    (statusFilter === 'pending' && !item.complete);
                
                const matchesPharmacy = !pharmacyFilter || item.pharmacie === pharmacyFilter;
                
                return matchesSearch && matchesCategory && matchesStatus && matchesPharmacy;
            });
            
            document.getElementById('checklistCount').textContent = `${checklistItems.length} item(s)`;
            
            const container = document.getElementById('checklistItems');
            
            if (checklistItems.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="bi bi-check-square display-1 text-muted"></i>
                        <h3 class="mt-3">Aucune checklist</h3>
                        <p class="text-muted">Commencez par cr√©er votre premi√®re note checklist</p>
                        <button class="btn btn-primary" onclick="openChecklistModal()">
                            <i class="bi bi-plus"></i> Nouvelle checklist
                        </button>
                    </div>
                `;
                return;
            }
            
            // Separate favorites and categorized items
            const favoriteItems = checklistItems.filter(item => item.favori);
            const regularItems = checklistItems.filter(item => !item.favori);
            
            let html = '';
            
            if (favoriteItems.length > 0) {
                html += `
                    <div class="mb-4">
                        <h4 class="d-flex align-items-center mb-3">
                            <i class="bi bi-star-fill text-warning me-2"></i>
                            Favoris
                        </h4>
                        <div class="row g-3">
                            ${favoriteItems.map(item => renderChecklistCard(item)).join('')}
                        </div>
                    </div>
                `;
            }
            
            // Group regular items by category
            const categorizedItems = {};
            regularItems.forEach(item => {
                if (!categorizedItems[item.categorie]) {
                    categorizedItems[item.categorie] = [];
                }
                categorizedItems[item.categorie].push(item);
            });
            
            Object.entries(categorizedItems).forEach(([category, items]) => {
                const categoryInfo = getCategoryInfo(category);
                html += `
                    <div class="mb-4">
                        <h4 class="d-flex align-items-center mb-3">
                            <span style="color: ${categoryInfo.color}">
                                ${categoryInfo.icon} ${categoryInfo.name}
                            </span>
                            <span class="badge bg-secondary ms-3">${items.length}</span>
                        </h4>
                        <div class="row g-3">
                            ${items.map(item => renderChecklistCard(item)).join('')}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function getCategoryInfo(category) {
            const categories = {
                'logistique': { name: 'Logistique', icon: 'üì¶', color: '#e74c3c' },
                'patient': { name: 'Patient', icon: 'üë§', color: '#3498db' },
                'ordinateur': { name: 'Ordinateur', icon: 'üíª', color: '#9b59b6' },
                'todo': { name: 'Todo', icon: '‚úÖ', color: '#f39c12' },
                'medecin': { name: 'M√©decin', icon: 'üë®‚Äç‚öïÔ∏è', color: '#2ecc71' },
                'procedure': { name: 'Proc√©dure', icon: 'üìã', color: '#34495e' },
                'grossiste': { name: 'Grossiste', icon: 'üè¢', color: '#e67e22' },
                'magistrale': { name: 'Magistrale', icon: '‚öóÔ∏è', color: '#1abc9c' },
                'tarification': { name: 'Tarification', icon: 'üí∞', color: '#95a5a6' }
            };
            return categories[category] || { name: category, icon: 'üìã', color: '#333' };
        }

        function renderChecklistCard(item) {
            const categoryInfo = getCategoryInfo(item.categorie);
            
            return `
                <div class="col-md-6 col-lg-4">
                    <div class="card h-100 ${item.favori ? 'border-warning' : ''} ${item.complete ? 'opacity-75' : ''}">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div class="flex-fill">
                                    <div class="d-flex align-items-center mb-3">
                                        ${item.favori ? '<i class="bi bi-star-fill text-warning me-2"></i>' : ''}
                                        <h6 class="card-title mb-0">${item.titre}</h6>
                                        <span class="badge ms-2" style="background-color: ${categoryInfo.color}">
                                            ${categoryInfo.icon} ${categoryInfo.name}
                                        </span>
                                    </div>
                                    
                                    <p class="card-text text-muted small" style="display: -webkit-box; -webkit-line-clamp: 4; -webkit-box-orient: vertical; overflow: hidden;">
                                        ${item.contenu}
                                    </p>
                                    
                                    ${item.images && item.images.length > 0 ? `
                                        <div class="mb-3">
                                            <div class="d-flex align-items-center mb-2">
                                                <i class="bi bi-image me-2 text-muted"></i>
                                                <small class="text-muted">${item.images.length} image(s)</small>
                                            </div>
                                            <div class="d-flex gap-1">
                                                ${item.images.slice(0, 3).map((img, index) => `
                                                    <img src="${img}" alt="Image ${index + 1}" class="img-thumbnail" style="width: 40px; height: 40px; object-fit: cover; cursor: pointer;" onclick="window.open('${img}', '_blank')">
                                                `).join('')}
                                                ${item.images.length > 3 ? `
                                                    <div class="d-flex align-items-center justify-content-center bg-light border rounded" style="width: 40px; height: 40px;">
                                                        <small class="text-muted">+${item.images.length - 3}</small>
                                                    </div>
                                                ` : ''}
                                            </div>
                                        </div>
                                    ` : ''}
                                    
                                    ${item.tableau && item.tableau.colonnes.length > 0 ? `
                                        <div class="mb-3">
                                            <div class="small text-muted mb-2">üìä Tableau inclus</div>
                                            <div class="bg-dark p-2 rounded border small">
                                                <strong>Colonnes:</strong> ${item.tableau.colonnes.join(', ')}<br>
                                                <strong>Lignes:</strong> ${item.tableau.lignes.length}
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>
                                
                                <div class="d-flex flex-column gap-2">
                                    <button class="btn btn-sm btn-outline-primary" onclick="openChecklistModal(${JSON.stringify(item).replace(/"/g, '&quot;')})" title="Modifier">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-sm ${item.complete ? 'btn-outline-warning' : 'btn-outline-success'}" onclick="toggleChecklistComplete('${item.id}')" title="${item.complete ? 'Marquer comme en cours' : 'Marquer comme compl√©t√©'}">
                                        <i class="bi bi-${item.complete ? 'arrow-clockwise' : 'check'}"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteChecklistItem('${item.id}')" title="Supprimer">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer bg-transparent">
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted">üìÖ ${new Date(item.dateCreation).toLocaleDateString('fr-FR')}</small>
                                <span class="small ${item.complete ? 'text-success' : 'text-primary'}">
                                    ${item.complete ? '‚úÖ Compl√©t√©' : '‚è≥ En cours'}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function toggleChecklistComplete(id) {
            const checklistItems = getData('checklist_items');
            const item = checklistItems.find(c => c.id === id);
            if (item) {
                item.complete = !item.complete;
                setData('checklist_items', checklistItems);
                showNotification(`T√¢che ${item.complete ? 'compl√©t√©e' : 'remise en cours'}`);
                if (currentPage === 'checklist') loadChecklist();
                updateDashboard();
            }
        }

        // FONCTION DE SUPPRESSION CORRIG√âE
        function deleteChecklistItem(id) {
            console.log('Tentative de suppression de l\'item:', id); // Debug
            
            const checklistItems = getData('checklist_items');
            const item = checklistItems.find(c => c.id === id);
            
            console.log('Item trouv√©:', item); // Debug
            console.log('Nombre d\'items avant suppression:', checklistItems.length); // Debug
            
            if (item && confirm('√ätes-vous s√ªr de vouloir supprimer cette note checklist ?')) {
                // SUPPRESSION DIRECTE ET IMM√âDIATE
                const updatedItems = checklistItems.filter(c => c.id !== id);
                
                console.log('Nombre d\'items apr√®s filtrage:', updatedItems.length); // Debug
                
                // Sauvegarde imm√©diate
                localStorage.setItem('pharmaboard_checklist_items', JSON.stringify(updatedItems));
                
                // V√©rification de la sauvegarde
                const verifyItems = JSON.parse(localStorage.getItem('pharmaboard_checklist_items') || '[]');
                console.log('V√©rification - nombre d\'items sauv√©s:', verifyItems.length); // Debug
                
                showNotification('Note checklist supprim√©e avec succ√®s');
                
                // Rechargement imm√©diat de la page checklist
                if (currentPage === 'checklist') {
                    setTimeout(() => {
                        loadChecklist();
                        updateDashboard();
                    }, 100);
                }
                
                // Mise √† jour du dashboard
                updateDashboard();
            }
        }

        // Settings management
        function loadSettings() {
            updateSettingsInfo();
        }

        function updateSettingsInfo() {
            const pharmacies = getData('pharmacies');
            const contacts = getData('contacts');
            const notes = getData('notes');
            const messages = getData('messages');
            const checklistItems = getData('checklist_items');
            
            document.getElementById('infoPharmacies').textContent = pharmacies.length;
            document.getElementById('infoContacts').textContent = contacts.length;
            document.getElementById('infoNotes').textContent = notes.length;
            document.getElementById('infoMessages').textContent = messages.length;
            
            const completedTasks = checklistItems.filter(c => c.complete).length;
            document.getElementById('infoChecklist').textContent = `${checklistItems.length} items (${completedTasks} compl√©t√©s)`;
            
            document.getElementById('lastSave').textContent = new Date().toLocaleString('fr-FR');
        }

        function exportData() {
            const data = {
                pharmacies: getData('pharmacies'),
                contacts: getData('contacts'),
                notes: getData('notes'),
                messages: getData('messages'),
                checklist_items: getData('checklist_items'),
                currentPharmacy: currentPharmacy,
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `pharmaboard_backup_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            showNotification('Donn√©es export√©es avec succ√®s');
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const importedData = JSON.parse(event.target.result);
                        if (confirm('√ätes-vous s√ªr de vouloir importer ces donn√©es ? Cela remplacera toutes les donn√©es actuelles.')) {
                            // Save each data type to localStorage
                            Object.keys(importedData).forEach(key => {
                                if (key !== 'currentPharmacy') {
                                    setData(key, importedData[key]);
                                } else {
                                    if (importedData[key]) {
                                        localStorage.setItem('pharmaboard_current_pharmacy', importedData[key]);
                                        currentPharmacy = importedData[key];
                                    }
                                }
                            });
                            showNotification('Donn√©es import√©es avec succ√®s');
                            setTimeout(() => window.location.reload(), 1000);
                        }
                    } catch (error) {
                        showNotification('Erreur lors de l\'importation : fichier invalide', 'error');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function clearAllData() {
            if (confirm('√ätes-vous s√ªr de vouloir effacer toutes les donn√©es ? Cette action est irr√©versible.')) {
                if (confirm('Derni√®re confirmation : toutes vos donn√©es seront perdues !')) {
                    localStorage.clear();
                    showNotification('Toutes les donn√©es ont √©t√© effac√©es');
                    setTimeout(() => window.location.reload(), 1000);
                }
            }
        }

        function toggleAutoSave() {
            const enabled = document.getElementById('autoSaveToggle').checked;
            showNotification(`Sauvegarde automatique ${enabled ? 'activ√©e' : 'd√©sactiv√©e'}`);
        }

        function toggleNotifications() {
            const enabled = document.getElementById('notificationsToggle').checked;
            showNotification(`Notifications ${enabled ? 'activ√©es' : 'd√©sactiv√©es'}`);
        }

        // Notification system
        function showNotification(message, type = 'success') {
            const toast = document.getElementById('notificationToast');
            const toastMessage = document.getElementById('toastMessage');
            
            // Update icon and color based on type
            const header = toast.querySelector('.toast-header i');
            header.className = `bi me-2 ${type === 'error' ? 'bi-exclamation-triangle text-danger' : 'bi-info-circle text-primary'}`;
            
            toastMessage.textContent = message;
            
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
        }
    </script>
</body>
</html>
